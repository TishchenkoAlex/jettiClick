<form novalidate [formGroup]="viewModel.formGroup">
  <p-panel [header]="viewModel.model.description.concat(viewModel.model.posted ? ', [posted]' : ', [unposted]')" [toggleable]="true">
    <p-toolbar>
      <div class="ui-toolbar-group-left">
        <ng-container *ngTemplateOutlet="actionTepmlate ? actionTepmlate : actionTepmlateDefault; context: {viewModel: viewModel}"></ng-container>
      </div>
      <div class="ui-toolbar-group-right">
        <button pButton type="button" icon="fa-list" class="ui-button-secondary" (click)="Goto()"></button>
        <button pButton type="button" icon="fa-print" class="ui-button-secondary" (click)="Print()"></button>
        <button #cb pButton type="button" icon="fa-close" class="ui-button-danger" (click)="Close()"></button>
      </div>
    </p-toolbar>

    <ng-container *ngTemplateOutlet="formTepmlate? formTepmlate: formTepmlateDefault; context: {viewModel: viewModel}"></ng-container>
    <ng-content></ng-content>
  </p-panel>

  <p-panel [toggleable]="true" header="Additonal Info">
    <div fxLayout="row" fxLayoutGap="35px" fxLayout.xs="column">
      <j-control *ngIf="viewModel.controlsByKey['parent']" [control]="viewModel.controlsByKey['parent']" [form]="viewModel.formGroup"></j-control>
      <j-control *ngIf="viewModel.controlsByKey['user']" [control]="viewModel.controlsByKey['user']" [form]="viewModel.formGroup"></j-control>
    </div>
    <j-control *ngIf="viewModel.controlsByKey['info']" [control]="viewModel.controlsByKey['info']" [form]="viewModel.formGroup"></j-control>
    <div *ngFor="let control of viewModel.view; let i = index" fxLayout="column">
      <j-control *ngIf="control.controlType === 'script'" [control]="control" [form]="viewModel.formGroup"></j-control>
    </div>
  </p-panel>

  <p-panel [toggleable]="true" [collapsed]="true" header="Register movements" #accumulation *ngIf="this.viewModel.model.type.startsWith('Document.') && viewModel.model.posted">
    <j-register-movement *ngIf="!accumulation.collapsed" [doc]="viewModel.model"></j-register-movement>
    <j-register-accumulation-list *ngIf="!accumulation.collapsed" [doc]="viewModel.model"></j-register-accumulation-list>
  </p-panel>

</form>

<ng-template #formTepmlateDefault let-v="viewModel">

  <div fxLayout="column">

    <div fxLayout="row" fxLayout.xs="column" fxLayoutGap="35px">
      <div fxLayoutGap.gt-xs="column" fxFlex>
        <div *ngFor="let control of v.view; let i = index">
          <j-control *ngIf="(control.order-1)%3+1 === 1 && control.order && control.type !== 'table'" [control]="control" [form]="v.formGroup"></j-control>
        </div>
      </div>
      <div fxLayoutGap.gt-xs="column" fxFlex>
        <div *ngFor="let control of v.view; let i = index">
          <j-control *ngIf="(control.order-1)%3+1 === 2 && control.order && control.type !== 'table'" [control]="control" [form]="v.formGroup"></j-control>
        </div>
      </div>
      <div fxLayoutGap.gt-xs="column" fxFlex>
        <div *ngFor="let control of v.view; let i = index">
          <j-control *ngIf="(control.order-1)%3+1 === 3 && control.order && control.type !== 'table'" [control]="control" [form]="v.formGroup"></j-control>
        </div>
      </div>
    </div>

    <div *ngFor="let control of v.view; let i = index">
      <j-control *ngIf="control.order < 1 && ( 
            (control.key !== 'parent') && (control.key !== 'user') && (control.key !== 'info') && (control.controlType !== 'script'))"
        [control]="control" [form]="v.formGroup"></j-control>
    </div>

    <br *ngIf="hasTables">
    <p-tabView *ngIf="hasTables" class="tabViewClassInForm">
      <div *ngFor="let control of v.view; let i = index">
        <p-tabPanel [style]="{'padding':'0'}" *ngIf="control.type === 'table'" [header]="control.label">
          <j-control [control]="control" [form]="v.formGroup"></j-control>
        </p-tabPanel>
      </div>
    </p-tabView>

  </div>
</ng-template>

<ng-template #actionTepmlateDefault let-v="viewModel">

  <button pButton type="button" icon="fa-check-square-o" fxHide fxShow.gt-xs label="Post&Close" class="ui-button-warning" [disabled]="!v.formGroup.valid"
    (click)="PostClose()" *ngIf="!v.model.deleted"></button>
  <button pButton type="button" icon="fa-check-square-o" fxShow fxHide.gt-xs class="ui-button-warning" [disabled]="!v.formGroup.valid"
    (click)="PostClose()" *ngIf="!v.model.deleted"></button>

  <button pButton type="button" icon="fa-check" class="ui-button-secondary" [disabled]="!v.formGroup.valid" (click)="Post()"
    *ngIf="!v.model.deleted"></button>
  <button pButton type="button" icon="fa-floppy-o" class="ui-button-secondary" [disabled]="!v.formGroup.valid" (click)="Save()"
    *ngIf="!v.model.deleted && !v.model.posted"></button>
  <button pButton type="button" icon="fa-clone" class="ui-button-secondary" [disabled]="!v.formGroup.valid" (click)="Copy()"
    *ngIf="!v.model.deleted && !v.model.description.toLowerCase().startsWith('copy')"></button>
  <button pButton type="button" icon="fa-undo" class="ui-button-secondary" [disabled]="!v.formGroup.valid" (click)="unPost()"
    *ngIf="!v.model.deleted && v.model.posted"></button>
  <button pButton type="button" icon="fa-minus" class="ui-button-{{v.model.deleted ? 'warning' : 'danger'}}" 
    [disabled]="(!v.formGroup.valid ) || (v.model.description.toLowerCase().startsWith('copy')) || (v.model.description.toLowerCase().startsWith('new'))"
    (click)="Delete()"></button>
</ng-template>

<ng-template #sideNavTepmlate let-sidenav="sidenav">
  <div>
    <button type="button" pButton (click)="this.Goto(); sidenav.close()">Find in list</button>
    <button type="button" pButton (click)="sidenav.close()">Close</button>
  </div>
</ng-template>

<p-confirmDialog></p-confirmDialog>